<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Toast UI Editor + Flask</title>
  <!-- Toast UI Editor CSS (CDN) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <!-- Local Color Picker + Color Syntax plugin CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/tui-color-syntax/tui-color-picker.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/tui-color-syntax/toastui-editor-plugin-color-syntax.min.css') }}">
  <style>
    /* Estilos base para resaltado de texto */
    .text-highlight {
      padding: 2px 4px !important;
      border-radius: 2px !important;
      font-style: normal !important;
    }
    
    /* Colores de resaltado usando clases CSS */
    .text-highlight.hl-yellow { background-color: #ffff00 !important; }
    .text-highlight.hl-green { background-color: #90EE90 !important; }
    .text-highlight.hl-blue { background-color: #ADD8E6 !important; }
    .text-highlight.hl-pink { background-color: #FFB6C1 !important; }
    .text-highlight.hl-orange { background-color: #FFD580 !important; }
    .text-highlight.hl-purple { background-color: #DDA0DD !important; }
    
    /* Estilos para enlaces PDF */
    a[href*=".pdf"],
    a[href^="/pdf/"] {
      color: #0066cc !important;
      text-decoration: underline !important;
      cursor: pointer !important;
    }
    
    a[href*=".pdf"]:hover,
    a[href^="/pdf/"]:hover {
      color: #004499 !important;
      background-color: #f0f8ff !important;
    }
    
    /* Men√∫ de colores */
    .highlight-color-menu {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 8px;
      z-index: 1000;
      gap: 4px;
      grid-template-columns: repeat(3, 1fr);
    }
    
    .highlight-color-menu.show {
      display: grid;
    }
    
    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }
    
    .color-option:hover {
      border-color: #333;
    }
  </style>
</head>
<body style="margin:0; padding:8px;">
  <div style="display:flex; gap:16px; align-items:flex-start; width:1920px; max-width:100vw;">
  <div style="display:flex; gap:16px; width:100%;">
    <aside id="explorer" style="width:240px; border-right:1px solid #ddd; padding-right:12px;">
      <h3>Archivos guardados</h3>
        <div>
          <button id="refreshFiles">Refrescar</button>
          <button id="newFile">Nuevo archivo</button>
          <button id="createDir">Crear carpeta</button>
          <button id="downloadOdt" title="Descargar el archivo actual como ODT">Descargar ODT</button>
        </div>
        <div id="breadcrumb" style="margin-top:8px; font-size:0.95em; color:#333;"></div>
        <ul id="fileList" style="list-style:none; padding-left:0; margin-top:8px;"></ul>
    </aside>

    <div id="splitter" title="Redimensionar explorador" style="width:12px; cursor:col-resize; background:transparent; height:500px; align-self:stretch; z-index:1000; touch-action:none; display:flex; align-items:center; justify-content:center;">
      <div style="width:2px; height:60%; background:#c0c0c0; border-radius:2px; box-shadow:0 0 0 1px rgba(0,0,0,0.02) inset;"></div>
    </div>
    <div id="mainArea" style="flex:1;">
      <form method="POST">
        <div id="editor"></div>
        <input type="hidden" name="content" id="content">
        <input type="hidden" name="preview_filename" id="preview_filename">
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <button type="submit">Vista previa</button>
          <button type="button" id="saveFile">Guardar</button>
          <span id="currentFile" style="margin-left:12px; color:#555">(archivo: <em>nuevo</em>)</span>
        </div>
        <div style="margin-top:8px;">
          <button type="button" id="toggleExplorer">Ocultar explorador</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast UI Editor JS (CDN) -->
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <!-- Local Color Picker + Color Syntax plugin JS -->
  <script src="{{ url_for('static', filename='vendor/tui-color-syntax/tui-color-picker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/tui-color-syntax/toastui-editor-plugin-color-syntax.min.js') }}"></script>
  <script>
    // Verificar que Toast UI se carg√≥
    console.log('Toast UI cargado:', !!window.toastui);
  </script>
  <script>
    function startEditor() {
      try {
        if (!(window.toastui && toastui.Editor)) {
          throw new Error('toastui.Editor no disponible');
        }

      let colorPlugin = null;
      try {
        // Toast UI color syntax plugin se registra como toastui.Editor.plugin.colorSyntax
        if (toastui.Editor.plugin && toastui.Editor.plugin.colorSyntax) {
          colorPlugin = toastui.Editor.plugin.colorSyntax;
        }
      } catch (e) {
        // Plugin no disponible
      }

      const editorConfig = {
        el: document.querySelector('#editor'),
        height: '500px',
        initialEditType: 'wysiwyg',
        previewStyle: 'tab',
        usageStatistics: false,
        customHTMLSanitizer: (html) => {
          // No sanitizar, permitir todo el HTML (incluyendo <mark>)
          return html;
        },
        customHTMLRenderer: {
          htmlInline: {
            mark(node, context) {
              return [
                { type: 'openTag', tagName: 'mark', outerNewLine: false },
                { type: 'html', content: node.literal },
                { type: 'closeTag', tagName: 'mark', outerNewLine: false }
              ];
            }
          }
        },
        toolbar: [
          'heading',
          'bold',
          'italic',
          'strike',
          'hr',
          'quote',
          'ul',
          'ol',
          'task',
          'indent',
          'outdent',
          'table',
          'image',
          'link',
          'code',
          'codeblock'
        ]
      };

      // Agregar el plugin si est√° disponible
      if (colorPlugin) {
        editorConfig.plugins = [colorPlugin];
      }

      const editor = new toastui.Editor(editorConfig);

      // Funci√≥n para aplicar colores a todos los marks con data-color
      function applyMarkColors() {
        setTimeout(() => {
          // Buscar en toda la p√°gina, no solo en selectores espec√≠ficos
          const allMarks = document.querySelectorAll('mark[data-color]');
          const colorMap = {
            'yellow': '#ffff00',
            'green': '#90EE90',
            'blue': '#ADD8E6',
            'pink': '#FFB6C1',
            'orange': '#FFD580',
            'purple': '#DDA0DD'
          };
          
          console.log('Buscando marks... encontrados:', allMarks.length);
          
          allMarks.forEach(m => {
            const color = m.getAttribute('data-color');
            console.log('Mark encontrado con color:', color, 'Elemento:', m);
            if (color && colorMap[color]) {
              m.style.backgroundColor = colorMap[color];
              m.style.padding = '2px 4px';
              m.style.borderRadius = '2px';
              console.log('Estilo aplicado:', m.style.backgroundColor);
            }
          });
          console.log('Colores aplicados a', allMarks.length, 'elementos mark');
        }, 200); // Aumentado el delay
      }

      // MutationObserver para detectar cambios y reaplicar estilos
      const observer = new MutationObserver(() => {
        const marks = document.querySelectorAll('mark[data-color]');
        const colorMap = {
          'yellow': '#ffff00',
          'green': '#90EE90',
          'blue': '#ADD8E6',
          'pink': '#FFB6C1',
          'orange': '#FFD580',
          'purple': '#DDA0DD'
        };
        marks.forEach(m => {
          const color = m.getAttribute('data-color');
          if (color && colorMap[color] && m.style.backgroundColor !== colorMap[color]) {
            m.style.backgroundColor = colorMap[color];
            m.style.padding = '2px 4px';
            m.style.borderRadius = '2px';
          }
        });
      });
      
      // Observar cambios en el editor
      setTimeout(() => {
        const editorEl = document.querySelector('#editor');
        if (editorEl) {
          observer.observe(editorEl, { 
            childList: true, 
            subtree: true, 
            attributes: true,
            attributeFilter: ['style']
          });
          console.log('MutationObserver activado para mantener colores');
        }
      }, 500);

      // Hook para convertir ==texto== a <mark>texto</mark> en el preview
      editor.eventEmitter.listen('beforePreviewRender', (html) => {
        // Reemplazar ==texto== con <mark>texto</mark>
        return html.replace(/==([^=]+)==/g, '<mark>$1</mark>');
      });

      // Funcionalidad Ctrl+clic para abrir enlaces en nueva pesta√±a
      setTimeout(() => {
        const editorEl = document.querySelector('#editor');
        if (editorEl) {
          editorEl.addEventListener('click', (e) => {
            let target = e.target;
            
            // Buscar si el elemento clickeado o alg√∫n padre tiene data-pdf-path
            for (let i = 0; i < 5 && target; i++) {
              const pdfPath = target.getAttribute && target.getAttribute('data-pdf-path');
              
              if (pdfPath) {
                e.preventDefault();
                e.stopPropagation();
                
                // Abrir PDF directamente con URL transparente
                const pdfUrl = '/pdf_absolute/' + pdfPath;
                window.open(pdfUrl, '_blank');
                return;
              }
              
              target = target.parentElement;
            }
            
            // Ctrl+clic para enlaces normales
            if (e.ctrlKey || e.metaKey) {
              target = e.target;
              for (let i = 0; i < 5 && target; i++) {
                if (target.tagName === 'A' && target.href && !target.href.startsWith('#')) {
                  e.preventDefault();
                  e.stopPropagation();
                  window.open(target.href, '_blank');
                  return;
                }
                target = target.parentElement;
              }
            }
          });
          console.log('Ctrl+clic en enlaces habilitado');
          
          // Interceptar evento de paste para detectar URLs de PDF
          // Usar capture: true para interceptar antes que Toast UI
          editorEl.addEventListener('paste', (e) => {
            const pastedText = e.clipboardData.getData('text');
            
            // Detectar si es una URL file:/// con PDF
            const fileUrlMatch = pastedText.match(/file:\/\/\/([A-Za-z]:\/[^\s]+\.pdf)/i);
            // Detectar si es una URL HTTP/HTTPS con PDF
            const httpUrlMatch = pastedText.match(/(https?:\/\/[^\s]+\.pdf)/i);
            
            if (fileUrlMatch) {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              
              // Decodificar la URL
              const encodedPath = fileUrlMatch[1];
              const decodedPath = decodeURIComponent(encodedPath);
              
              // Codificar la ruta en base64 para pasarla de forma segura
              const base64Path = btoa(decodedPath);
              
              // Usar setTimeout para asegurar que se ejecute despu√©s del ciclo de eventos
              setTimeout(() => {
                if (editor.isWysiwygMode()) {
                  // En modo WYSIWYG, insertar HTML directamente
                  const selection = window.getSelection();
                  if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    
                    // Crear span con estilo de enlace para PDFs locales
                    const link = document.createElement('span');
                    link.setAttribute('data-pdf-path', base64Path);
                    link.setAttribute('data-pdf-display', decodedPath);
                    link.setAttribute('role', 'link');
                    link.style.color = '#0066cc';
                    link.style.textDecoration = 'underline';
                    link.style.cursor = 'pointer';
                    link.textContent = decodedPath;
                    
                    range.insertNode(link);
                    
                    // Agregar espacio despu√©s del enlace
                    const space = document.createTextNode(' ');
                    range.setStartAfter(link);
                    range.insertNode(space);
                    
                    // Mover cursor despu√©s del espacio
                    range.setStartAfter(space);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                  }
                } else {
                  // En modo Markdown, insertar sintaxis de enlace
                  const mdLink = `[${decodedPath}](#pdf-${base64Path})`;
                  editor.insertText(mdLink);
                }
                
                console.log('Enlace PDF local insertado:', decodedPath);
              }, 0);
            } else if (httpUrlMatch) {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              
              const pdfUrl = httpUrlMatch[1];
              
              // Usar setTimeout para asegurar que se ejecute despu√©s del ciclo de eventos
              setTimeout(() => {
                if (editor.isWysiwygMode()) {
                  const selection = window.getSelection();
                  if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    
                    // Crear enlace <a> normal para URLs HTTP/HTTPS
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.target = '_blank';
                    link.style.color = '#0066cc';
                    link.style.textDecoration = 'underline';
                    link.textContent = pdfUrl;
                    
                    range.insertNode(link);
                    
                    // Agregar espacio despu√©s del enlace
                    const space = document.createTextNode(' ');
                    range.setStartAfter(link);
                    range.insertNode(space);
                    
                    // Mover cursor despu√©s del espacio
                    range.setStartAfter(space);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                  }
                } else {
                  // En modo Markdown, insertar sintaxis de enlace
                  const mdLink = `[${pdfUrl}](${pdfUrl})`;
                  editor.insertText(mdLink);
                }
                
                console.log('Enlace PDF HTTP insertado:', pdfUrl);
              }, 0);
            }
          }, true); // true = usar capture phase
        }
      }, 500);

      // Agregar el bot√≥n al toolbar (despu√©s de que se renderice)
      setTimeout(() => {
        const toolbar = document.querySelector('.toastui-editor-defaultUI-toolbar');
        if (toolbar) {
          // Crear contenedor para bot√≥n y men√∫
          const highlightContainer = document.createElement('div');
          highlightContainer.style.cssText = 'position: relative; display: inline-block;';
          
          // Crear el bot√≥n de resaltado
          const toolbarItem = document.createElement('button');
          toolbarItem.type = 'button';
          toolbarItem.className = 'toastui-editor-toolbar-icons';
          toolbarItem.innerHTML = '<span style="font-size:16px; display:inline-block; background:yellow; padding:2px 4px; border-radius:2px; font-weight:bold; color:#000;">A</span>';
          toolbarItem.title = 'Resaltar texto (Highlight)';
          
          // Crear men√∫ de colores
          const colorMenu = document.createElement('div');
          colorMenu.className = 'highlight-color-menu';
          
          const colors = [
            { name: 'yellow', color: '#ffff00' },
            { name: 'green', color: '#90EE90' },
            { name: 'blue', color: '#ADD8E6' },
            { name: 'pink', color: '#FFB6C1' },
            { name: 'orange', color: '#FFD580' },
            { name: 'purple', color: '#DDA0DD' }
          ];
          
          colors.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'color-option';
            btn.style.backgroundColor = c.color;
            btn.title = c.name;
            btn.dataset.color = c.name;
            btn.dataset.colorHex = c.color;
            colorMenu.appendChild(btn);
          });
          
          highlightContainer.appendChild(toolbarItem);
          highlightContainer.appendChild(colorMenu);
          
          // Mostrar/ocultar men√∫ al hacer clic en el bot√≥n
          toolbarItem.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            colorMenu.classList.toggle('show');
          });
          
          // Cerrar men√∫ al hacer clic fuera
          document.addEventListener('click', (e) => {
            if (!highlightContainer.contains(e.target)) {
              colorMenu.classList.remove('show');
            }
          });
          
          // Funci√≥n para aplicar resaltado con color
          const applyHighlight = (colorName, colorHex) => {
            try {
              // Verificar que estamos en modo WYSIWYG
              if (!editor.isWysiwygMode()) {
                editor.changeMode('wysiwyg');
                setTimeout(() => applyHighlight(colorName, colorHex), 100);
                return;
              }
              
              // Obtener la selecci√≥n actual
              const selection = window.getSelection();
              if (!selection.rangeCount) {
                alert('Por favor, selecciona texto en el editor primero');
                colorMenu.classList.remove('show');
                return;
              }
              
              const range = selection.getRangeAt(0);
              const selectedText = range.toString().trim();
              
              if (!selectedText) {
                alert('Por favor, selecciona texto en el editor primero');
                colorMenu.classList.remove('show');
                return;
              }
              
              // Crear span con clases CSS que Toast UI preserve
              const span = document.createElement('span');
              span.className = 'text-highlight hl-' + colorName;
              span.style.cssText = `background-color: ${colorHex}; padding: 2px 4px; border-radius: 2px;`;
              span.textContent = selectedText;
              
              console.log('Creando span con color:', colorName, 'Hex:', colorHex, 'Clases:', span.className);
              
              // Eliminar el contenido seleccionado e insertar el span
              range.deleteContents();
              range.insertNode(span);
              
              console.log('Elemento insertado:', span, 'con clases:', span.getAttribute('class'));
              
              // Agregar un espacio despu√©s para evitar que se pegue con el siguiente texto
              const space = document.createTextNode(' ');
              range.setStartAfter(span);
              range.insertNode(space);
              
              // Colapsar la selecci√≥n despu√©s del espacio
              range.setStartAfter(space);
              range.collapse(true);
              selection.removeAllRanges();
              selection.addRange(range);
              
              // Cerrar el men√∫
              colorMenu.classList.remove('show');
              
            } catch (err) {
              console.error('Error al resaltar:', err);
              alert('Error: ' + err.message);
            }
          };
          
          // Agregar evento a cada bot√≥n de color
          colorMenu.querySelectorAll('.color-option').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              const color = btn.dataset.color;
              const colorHex = btn.dataset.colorHex;
              applyHighlight(color, colorHex);
            });
          });
          
          // Agregar al final del toolbar
          toolbar.appendChild(highlightContainer);
        }
      }, 500);

      // Configurar hook para subir im√°genes
      editor.addHook('addImageBlobHook', async (blob, callback) => {
        const formData = new FormData();
        formData.append("file", blob);
        // Enviar el nombre del archivo actual si existe
        if (currentFile) {
          formData.append("current_filename", currentFile);
        }

        const response = await fetch("/upload_image", {
          method: "POST",
          body: formData
        });
        const result = await response.json();
        if (result.success) {
          callback(result.url, blob.name);
        } else {
          alert("Error al subir imagen: " + result.message);
        }
      });

        // Guardar Markdown y nombre de archivo actual en campos ocultos antes de enviar
        const form = document.querySelector("form");
        if (form) {
          form.addEventListener("submit", (e) => {
            const md = editor.getMarkdown();
            document.querySelector("#content").value = md;
            try {
              document.querySelector('#preview_filename').value = currentFile || '';
            } catch(ex){}
          });
        }

    // File explorer + load/edit/save
    let currentFile = null; // filename

    function setCurrentFile(name) {
      currentFile = name;
      const el = document.querySelector('#currentFile');
      if (!name) el.innerHTML = '(archivo: <em>nuevo</em>)';
      else el.innerHTML = '(archivo: <em>' + name + '</em>)';
    }

    // currentPath is a relative path inside SAVE_FOLDER ('' = root)
    let currentPath = '';

    async function refreshFiles() {
      const ul = document.querySelector('#fileList');
      ul.innerHTML = '<li>Cargando...</li>';
      try {
        const q = currentPath ? '?path=' + encodeURIComponent(currentPath) : '';
        const res = await fetch('/files' + q);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Error listing files');
        ul.innerHTML = '';

        // render breadcrumb
        const bc = document.getElementById('breadcrumb');
        bc.innerHTML = '';
        const rootCrumb = document.createElement('span');
        rootCrumb.style.cursor = 'pointer';
        rootCrumb.textContent = 'root';
        rootCrumb.addEventListener('click', () => { currentPath = ''; refreshFiles(); });
        bc.appendChild(rootCrumb);
        if (data.path) {
          const parts = data.path.split('/');
          let accum = '';
          parts.forEach((p, idx) => {
            const sep = document.createElement('span');
            sep.textContent = ' / ';
            bc.appendChild(sep);
            const crumb = document.createElement('span');
            crumb.style.cursor = 'pointer';
            crumb.textContent = p;
            accum = accum ? (accum + '/' + p) : p;
            crumb.addEventListener('click', () => { currentPath = accum; refreshFiles(); });
            bc.appendChild(crumb);
          });
        }

        // show parent link if any (also keep .. for quick up)
        if (data.parent) {
          const li = document.createElement('li');
          li.style.padding = '6px 4px';
          li.style.cursor = 'pointer';
          li.textContent = '.. (subir)';
          li.addEventListener('click', () => { currentPath = data.parent; refreshFiles(); });
          ul.appendChild(li);
        }

        if (data.files.length === 0) {
          ul.innerHTML += '<li><em>No hay archivos</em></li>';
          return;
        }
        data.files.forEach(f => {
          const li = document.createElement('li');
          li.style.padding = '6px 4px';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          const left = document.createElement('div');
          left.style.cursor = 'pointer';
          // icon on the left, name on the right
          const icon = document.createElement('span');
          icon.style.marginRight = '8px';
          const nameSpan = document.createElement('span');
          nameSpan.textContent = f.name;

          if (f.type === 'dir') {
            icon.textContent = 'üìÅ';
            left.addEventListener('click', () => { currentPath = currentPath ? (currentPath + '/' + f.name) : f.name; refreshFiles(); });
          } else {
            icon.textContent = 'üìÑ';
            left.addEventListener('click', () => loadFile((currentPath ? currentPath + '/' : '') + f.name));
          }
          left.appendChild(icon);
          left.appendChild(nameSpan);

          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '6px';

          const renameBtn = document.createElement('button');
          renameBtn.textContent = 'Renombrar';
          renameBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const newName = prompt('Nuevo nombre para "' + f.name + '" (puedes usar ruta relativa):');
            if (!newName) return alert('Nombre requerido');
            const oldPath = (currentPath ? currentPath + '/' : '') + f.name;
            try {
              const res = await fetch('/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old: oldPath, new: newName })
              });
              const r = await res.json();
              if (r.success) { alert('Renombrado a: ' + r.new); refreshFiles(); }
              else alert('Error renombrando: ' + (r.message || JSON.stringify(r)));
            } catch (err) { alert('Error de red: ' + err); }
          });

          const delBtn = document.createElement('button');
          delBtn.textContent = 'Eliminar';
          delBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!confirm('Eliminar "' + f.name + '" ? Esta acci√≥n es irreversible.')) return;
            const path = (currentPath ? currentPath + '/' : '') + f.name;
            try {
              const res = await fetch('/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: path })
              });
              const r = await res.json();
              if (r.success) { alert('Eliminado'); refreshFiles(); }
              else alert('Error eliminando: ' + (r.message || JSON.stringify(r)));
            } catch (err) { alert('Error de red: ' + err); }
          });

          actions.appendChild(renameBtn);
          actions.appendChild(delBtn);

          li.appendChild(left);
          li.appendChild(actions);
          ul.appendChild(li);
        });
      } catch (err) {
        ul.innerHTML = '<li>Error al listar archivos</li>';
        console.error(err);
      }
    }

    async function loadFile(name) {
      if (!confirm('Abrir "' + name + '" para editar?')) return;
      try {
        const res = await fetch('/file?name=' + encodeURIComponent(name));
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Error loading file');
        editor.setMarkdown(data.content);
        editor.changeMode('wysiwyg');
        applyMarkColors();
        setCurrentFile(data.name);
      } catch (err) {
        alert('Error al cargar archivo: ' + err);
      }
    }

        document.querySelector('#refreshFiles').addEventListener('click', refreshFiles);
        document.querySelector('#newFile').addEventListener('click', () => {
          if (!confirm('Crear nuevo documento (se perder√°n cambios no guardados)?')) return;
          editor.setMarkdown('');
          editor.changeMode('wysiwyg');
          applyMarkColors();
          setCurrentFile(null);
        });

        document.querySelector('#createDir').addEventListener('click', async () => {
      const name = prompt('Nombre de la nueva carpeta (sin /):');
      if (!name) { alert('Nombre requerido'); return; }
      try {
        const res = await fetch('/mkdir', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dirname: name, parent: currentPath })
        });
        const result = await res.json();
        if (result.success) {
          alert('Carpeta creada: ' + (result.path || name));
          // navigate into new dir
          currentPath = currentPath ? (currentPath + '/' + name) : name;
          refreshFiles();
        } else {
          alert('Error al crear carpeta: ' + (result.message || JSON.stringify(result)));
        }
      } catch (err) {
        alert('Error de red al crear carpeta: ' + err);
      }
    });

        document.querySelector('#downloadOdt').addEventListener('click', async () => {
          if (!currentFile) {
            alert('Primero debes guardar y seleccionar un archivo');
            return;
          }
          
          try {
            const res = await fetch('/download_odt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ filename: currentFile })
            });
            
            if (!res.ok) {
              const error = await res.json();
              alert('Error: ' + (error.message || 'No se pudo generar el ODT'));
              return;
            }
            
            // Download the file
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.replace(/\.md$/i, '.odt');
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } catch (err) {
            alert('Error al descargar ODT: ' + err);
          }
        });

    // Guardar archivo: si currentFile existe, lo sobreescribe; si no, pide nombre
    async function saveMarkdownFile() {
      const md = editor.getMarkdown();
      let filename = currentFile;
      if (!filename) {
        // Generar sugerencia de nombre con formato yymmdd
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const suggestedName = `${yy}${mm}${dd}`;
        
        filename = prompt('Nombre de archivo (ej: nota.md) ‚Äî requerido para guardar', suggestedName);
        if (!filename) { alert('Nombre requerido'); return; }
        
        // Agregar extensi√≥n .md si no tiene ninguna extensi√≥n
        if (!filename.includes('.')) {
          filename = filename + '.md';
        }
      }

      // if user provided a simple name and currentPath is set, save inside that folder
      const saveName = (currentPath ? (currentPath + '/' + filename) : filename);
      const body = { content: md, filename: saveName };
      try {
        const res = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (result.success) {
          alert('Archivo guardado en: ' + result.path);
          setCurrentFile(filename);
          refreshFiles();
        } else {
          alert('Error al guardar: ' + (result.message || JSON.stringify(result)));
        }
      } catch (err) {
        alert('Error de red al guardar archivo: ' + err);
      }
    }

        document.querySelector('#saveFile').addEventListener('click', saveMarkdownFile);

    // Inicializar
        setCurrentFile(null);
        refreshFiles();

    // Si la URL tiene ?file=..., cargar ese archivo autom√°ticamente al abrir el editor
    try {
      const params = new URLSearchParams(window.location.search);
      const f = params.get('file');
      if (f) {
        // fetch sin confirmaci√≥n
        (async () => {
          try {
            const res = await fetch('/file?name=' + encodeURIComponent(f));
            const data = await res.json();
            if (data.success) {
              editor.setMarkdown(data.content);
              editor.changeMode('wysiwyg');
              applyMarkColors();
              setCurrentFile(data.name);
            }
          } catch (e) {
            console.error('No se pudo cargar archivo desde query param', e);
          }
        })();
      }
    } catch(e){}

        // Toggle explorer visibility
        const explorer = document.getElementById('explorer');
        const toggleBtn = document.getElementById('toggleExplorer');
        const mainArea = document.getElementById('mainArea');
        // splitter must be obtained before setExplorerVisible uses it
        const splitter = document.getElementById('splitter');
    // restore width from previous session
    try {
      const w = localStorage.getItem('explorerWidth');
      if (w) document.getElementById('explorer').style.width = w + 'px';
    } catch(e){}

    function setExplorerVisible(visible) {
      if (visible) {
        explorer.style.display = '';
        splitter.style.display = '';
        toggleBtn.textContent = 'Ocultar explorador';
      } else {
        explorer.style.display = 'none';
        splitter.style.display = 'none';
        toggleBtn.textContent = 'Mostrar explorador';
      }
      try { localStorage.setItem('explorerVisible', visible ? '1' : '0'); } catch(e){}
    }

        toggleBtn.addEventListener('click', () => {
      const isVisible = explorer.style.display !== 'none';
      setExplorerVisible(!isVisible);
    });

    // initialize from localStorage (default visible)
        try {
          const v = localStorage.getItem('explorerVisible');
          if (v === '0') setExplorerVisible(false);
          else setExplorerVisible(true);
        } catch(e) { setExplorerVisible(true); }

    // Splitter (resizable explorer width)
    // Use Pointer events for more reliable dragging across browsers
        let startX = 0;
        let startWidth = 0;
        let pointerId = null;

        function onPointerMove(e) {
      if (pointerId === null) return;
      const dx = e.clientX - startX;
      let newWidth = Math.round(startWidth + dx);
      const minW = 120;
      const maxW = Math.max(300, window.innerWidth - 300);
      if (newWidth < minW) newWidth = minW;
      if (newWidth > maxW) newWidth = maxW;
      document.getElementById('explorer').style.width = newWidth + 'px';
    }

        function onPointerUp(e) {
      if (pointerId === null) return;
      try { splitter.releasePointerCapture(pointerId); } catch(_) {}
      pointerId = null;
      document.body.style.cursor = '';
      try {
        const w = Math.round(document.getElementById('explorer').getBoundingClientRect().width);
        localStorage.setItem('explorerWidth', w);
      } catch(e){}
      document.removeEventListener('pointermove', onPointerMove);
      document.removeEventListener('pointerup', onPointerUp);
    }

        splitter.addEventListener('pointerdown', (e) => {
      // only left button
      if (e.button !== 0) return;
      pointerId = e.pointerId;
      startX = e.clientX;
      startWidth = document.getElementById('explorer').getBoundingClientRect().width;
      document.body.style.cursor = 'col-resize';
      try { splitter.setPointerCapture(pointerId); } catch(_) {}
      document.addEventListener('pointermove', onPointerMove);
          document.addEventListener('pointerup', onPointerUp);
          e.preventDefault();
        });
      } catch (err) {
        console.error('No se pudo inicializar Toast UI Editor', err);
        alert('No se pudo cargar Toast UI Editor. Revisa la consola o la conexi√≥n.');
      }
    }

    // Iniciar despu√©s de que el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startEditor);
    } else {
      startEditor();
    }
  </script>
</body>
</html>
